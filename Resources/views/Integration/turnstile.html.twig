{#
Varables
  - field
  - formName (optional, string)
  - fieldPage
  - contactFields
  - companyFields
  - inBuilder
  - fields
  - inForm (optional, bool)
  - required (optional, bool)
#}
{% set defaultInputClass = 'text' %}
{% set containerType = 'div-wrapper' %}

{# start: field_helper #}
{% set defaultInputFormClass = defaultInputFormClass|default('') %}
{% set defaultLabelClass = defaultLabelClass|default('label') %}
{% set formName = formName|default('') %}
{% set defaultInputClass = 'mauticform-' ~ defaultInputClass %}
{% set defaultLabelClass = 'mauticform-' ~ defaultLabelClass %}
{% set containerClass = containerClass|default(containerType) %}
{% set order = field.order|default(0) %}
{% set validationMessage = '' %}

{% set inputAttributes = htmlAttributesStringToArray(field.inputAttributes|default('')) %}
{% set labelAttributes = htmlAttributesStringToArray(field.labelAttributes|default('')) %}
{% set containerAttributes = htmlAttributesStringToArray(field.containerAttributes|default('')) %}

{% if ignoreName is not defined or (ignoreName is defined and ignoreName is empty) %}
    {% set inputName = 'mauticform[' ~ field.alias ~ ']' %}
    {% if field.properties.multiple is defined %}
        {% set inputName = inputName ~ '[]' %}
    {% endif %}
    {% set inputAttributes = inputAttributes|merge({
        'name': inputName,
    }) %}
{% endif %}

{% if field.type not in ['checkboxgrp', 'radiogrp', 'textarea'] %}
    {% set inputAttributes = inputAttributes|merge({
        'value': field.defaultValue|default(''),
    }) %}
{% endif %}

{% if ignoreId is not defined or (ignoreId is defined and ignoreId is empty) %}
    {% set inputAttributes = inputAttributes|merge({
        'id': 'mauticform_input' ~ formName ~ '_' ~ field.alias,
    }) %}
    {% set labelAttributes = labelAttributes|merge({
        'id': 'mauticform_label' ~ formName ~ '_' ~ field.alias,
        'for': 'mauticform_input' ~ formName ~ '_' ~ field.alias,
    }) %}
{% endif %}

{% if field.properties.placeholder is defined and field.properties.placeholder is not empty %}
    {% set inputAttributes = inputAttributes|merge({
        'placeholder': field.properties.placeholder,
    }) %}
{% endif %}

{# Label and input #}
{% if inForm is defined and (true == inForm or inForm is not empty) %}
    {% if field.type in ['button', 'pagebreak'] %}
        {% set defaultInputFormClass = defaultInputFormClass ~ ' btn btn-ghost' %}
    {% endif %}

    {% set labelAttributes = labelAttributes|merge({
        'class': labelAttributes.class|default([])|merge([defaultLabelClass]),
    }) %}
    {% set inputAttributes = inputAttributes|merge({
        'disabled': 'disabled',
        'class': inputAttributes.class|default([])|merge([defaultInputClass, defaultInputFormClass]),
    }) %}
{% else %}
    {% set labelAttributes = labelAttributes|merge({
        'class': labelAttributes.class|default([])|merge([defaultLabelClass]),
    }) %}
    {% set inputAttributes = inputAttributes|merge({
        'class': inputAttributes.class|default([])|merge([defaultInputClass]),
    }) %}
{% endif %}

{# Container #}
{% set containerAttributes = containerAttributes|merge({
    'id': 'mauticform' ~ formName|default('') ~ '_' ~ id,
    'class': containerAttributes.class|default([])|merge([
        'mauticform-row',
        'mauticform-' ~ containerClass,
        'mauticform-field-' ~ order,
    ]),
}) %}
{% if field.parent and fields[field.parent] is defined %}
    {% set values = field.conditions.values|join('|') %}

    {% if field.conditions.any is not empty and 'notIn' != field.conditions.expr %}
        {% set values = '*' %}
    {% endif %}

    {% set containerAttributes = containerAttributes|merge({
        'data-mautic-form-show-on': fields[field.parent].alias ~ ':' ~ values,
        'data-mautic-form-expr': field.conditions.expr,
        'class': containerAttributes.class|merge([
            'mauticform-field-hidden',
        ]),
    }) %}
{% endif %}

{# Field is required #}
{% if field.isRequired is defined and field.isRequired %}
    {% set required = true %}
    {% set validationMessage = field.validationMessage %}
    {% if validationMessage is empty %}
        {% set validationMessage = 'mautic.form.field.generic.required'|trans([], 'validators') %}
    {% endif %}
    {% set containerAttributes = containerAttributes|merge({
        'class': containerAttributes.class|default([])|merge([
            'mauticform-required',
        ]),
        'data-validate': field.alias,
        'data-validation-type': field.type,
    }) %}
    {% if field.properties.multiple is defined and field.properties.multiple is not empty %}
        {% set containerAttributes = containerAttributes|merge({
            'data-validate-multiple': 'true',
        }) %}
    {% endif %}
{% elseif required is defined and true == required %}
    {# Forced to be required #}
    {% set containerAttributes = containerAttributes|merge({
        'class': containerAttributes.class|default([])|merge([
            'mauticform-required',
        ]),
    }) %}
{% endif %}
{# end: field_helper #}

{% set action = app.request.get('objectAction') %}
{% set settings = field.properties %}

{% set integrations = [] %}
{% if settings.integrations is defined and settings.integrations is not empty %}
    {% set integrations = settings.integrations[0:-1]|split(',') %}
{% endif %}

{% set formName = formName|replace({'_': ''})|default('mauticform') %}

{% block turnstile %}
    {% set siteKey = field.customParameters.site_key|default(null) %}
    {% set explicitConsent = field.properties.explicitConsent|default(false) %}
    {% set mmcSuffix = (formName|default('mauticform') ~ '_' ~ field.alias ~ '_' ~ id)|replace({' ': '', '-': '_'}) %}

    {% if field.showLabel %}
        <label {% for attrName, attrValue in labelAttributes %}{{ attrName }}="{% if attrValue is iterable %}{{ attrValue|join(' ') }}{% else %}{{ attrValue }}{% endif %}"{% endfor %}>
            {{ field.label }}
        </label>
    {% endif %}

    {% if inForm is defined and (true == inForm or inForm is not empty) %}
        <div style="padding: 10px; background: #f5f5f5; border: 1px dashed #ccc; text-align: center;">
            Cloudflare Turnstile Widget ({% if explicitConsent %}explicit{% else %}implicit{% endif %} consent mode)
        </div>
    {% else %}
        {# Global (page-level) helper, created once. Safe for multiple forms per page. #}
        <script type="text/javascript">
        (function () {
            if (window.__mmcTurnstile) {
                return;
            }

            window.__mmcTurnstile = {
                apiLoading: false,

                ensureApi: function (onReady) {
                    if (window.turnstile) {
                        onReady && onReady();
                        return;
                    }

                    // Already loading: poll until ready
                    if (this.apiLoading) {
                        var tries = 0;
                        var t = setInterval(function () {
                            tries++;
                            if (window.turnstile) {
                                clearInterval(t);
                                onReady && onReady();
                            }
                            if (tries > 50) clearInterval(t);
                        }, 100);
                        return;
                    }

                    this.apiLoading = true;

                    // Inject Turnstile API once
                    if (!document.querySelector('script[data-mmc-turnstile-api="1"]')) {
                        var s = document.createElement('script');
                        s.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';
                        s.async = true;
                        s.defer = true;
                        s.setAttribute('data-mmc-turnstile-api', '1');
                        s.onload = function () {
                            onReady && onReady();
                        };
                        document.head.appendChild(s);
                    } else {
                        // Script exists; poll until ready
                        var tries2 = 0;
                        var t2 = setInterval(function () {
                            tries2++;
                            if (window.turnstile) {
                                clearInterval(t2);
                                onReady && onReady();
                            }
                            if (tries2 > 50) clearInterval(t2);
                        }, 100);
                    }
                },

                renderEligible: function (root) {
                    if (!window.turnstile) return;
                    root = root || document;

                    var nodes = root.querySelectorAll('.mmc-turnstile');
                    nodes.forEach(function (el) {
                        if (el.dataset.rendered === '1') return;

                        // Consent-gated widgets render only when granted
                        if (el.dataset.consentRequired === '1' && el.dataset.consentGranted !== '1') {
                            return;
                        }

                        el.dataset.rendered = '1';

                        window.turnstile.render(el, {
                            sitekey: el.dataset.sitekey,
                            size: el.dataset.size || 'normal',
                            theme: el.dataset.theme || 'auto',
                            'response-field-name': el.dataset.responseFieldName || 'cf-turnstile-response'
                        });
                    });
                },

                wireConsentCheckboxes: function () {
                    if (document.body.dataset.mmcTurnstileWired === '1') return;
                    document.body.dataset.mmcTurnstileWired = '1';

                    document.addEventListener('change', function (e) {
                        var cb = e.target;
                        if (!cb || !cb.classList || !cb.classList.contains('mmc-turnstile-consent')) return;
                        if (!cb.checked) return;

                        var wrapper = cb.closest('[data-mmc-turnstile-wrapper]');
                        if (!wrapper) return;

                        var widget = wrapper.querySelector('.mmc-turnstile');
                        if (!widget) return;

                        widget.dataset.consentGranted = '1';
                        cb.disabled = true;

                        window.__mmcTurnstile.ensureApi(function () {
                            window.__mmcTurnstile.renderEligible(wrapper);
                        });
                    }, true);
                },

                observe: function () {
                    if (document.body.dataset.mmcTurnstileObserved === '1') return;
                    document.body.dataset.mmcTurnstileObserved = '1';

                    // MutationObserver to handle dynamic inserts (page builders / script embed reinits)
                    if (!('MutationObserver' in window)) return;

                    var obs = new MutationObserver(function (mutations) {
                        for (var i = 0; i < mutations.length; i++) {
                            var m = mutations[i];
                            for (var j = 0; j < m.addedNodes.length; j++) {
                                var n = m.addedNodes[j];
                                if (!n || n.nodeType !== 1) continue;

                                // If the added node is (or contains) a turnstile placeholder, try rendering
                                if (n.classList && n.classList.contains('mmc-turnstile')) {
                                    window.__mmcTurnstile.ensureApi(function () {
                                        window.__mmcTurnstile.renderEligible(document);
                                    });
                                    return;
                                }
                                if (n.querySelector && n.querySelector('.mmc-turnstile')) {
                                    window.__mmcTurnstile.ensureApi(function () {
                                        window.__mmcTurnstile.renderEligible(document);
                                    });
                                    return;
                                }
                            }
                        }
                    });

                    obs.observe(document.body, { childList: true, subtree: true });
                }
            };

            window.__mmcTurnstile.wireConsentCheckboxes();
            window.__mmcTurnstile.observe();

            // Try render on DOM ready and Mautic page events
            document.addEventListener('DOMContentLoaded', function () {
                window.__mmcTurnstile.ensureApi(function () {
                    window.__mmcTurnstile.renderEligible(document);
                });
            });

            document.addEventListener('mauticPageOnLoad', function () {
                window.__mmcTurnstile.ensureApi(function () {
                    window.__mmcTurnstile.renderEligible(document);
                });
            });
        })();
        </script>

        {% if explicitConsent %}
            <div data-mmc-turnstile-wrapper="{{ mmcSuffix }}">
                <div style="display:flex; align-items:flex-start;">
                    <input
                        type="checkbox"
                        class="mmc-turnstile-consent"
                        style="margin-right:1rem; margin-top:3px;"
                    />
                    <label>
                        {{ field.customParameters.stringBag["accept_cookies"] }}<br />
                        <strong>{{ field.customParameters.stringBag["accept_cookies.notice"] }}:</strong>
                        {{ field.customParameters.stringBag["accept_cookies.notice.value"] }}
                    </label>
                </div>
            </div>
        {% endif %}

        <div {% for attrName, attrValue in containerAttributes %}{{ attrName }}="{% if attrValue is iterable %}{{ attrValue|join(' ') }}{% else %}{{ attrValue }}{% endif %}"{% endfor %}>
            <div style="position: relative; top:25px; padding-bottom:25px">
                <span class="mauticform-errormsg" style="display: none;"></span>
            </div>

            {# Turnstile placeholder (one per form instance). #}
            <div
                class="mmc-turnstile"
                data-sitekey="{{ siteKey }}"
                data-size="{{ field.properties.size }}"
                data-theme="{{ field.properties.theme }}"
                data-response-field-name="cf-turnstile-response"
                data-consent-required="{% if explicitConsent %}1{% else %}0{% endif %}"
                data-consent-granted="{% if explicitConsent %}0{% else %}1{% endif %}"
                style="display:block; flex-flow:row;"
            ></div>
        </div>

        {# For implicit consent, attempt immediate render after this field is output. #}
        {% if not explicitConsent %}
            <script type="text/javascript">
            (function () {
                if (!window.__mmcTurnstile) return;
                window.__mmcTurnstile.ensureApi(function () {
                    window.__mmcTurnstile.renderEligible(document);
                });
            })();
            </script>
        {% endif %}
    {% endif %}
{% endblock %}
