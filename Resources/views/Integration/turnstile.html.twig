{#
Varables
  - field
  - formName (optional, string)
  - fieldPage
  - contactFields
  - companyFields
  - inBuilder
  - fields
  - inForm (optional, bool)
  - required (optional, bool)
#}
{% set defaultInputClass = 'text' %}
{% set containerType = 'div-wrapper' %}

{# start: field_helper #}
{% set defaultInputFormClass = defaultInputFormClass|default('') %}
{% set defaultLabelClass = defaultLabelClass|default('label') %}
{% set formName = formName|default('') %}
{% set defaultInputClass = 'mauticform-' ~ defaultInputClass %}
{% set defaultLabelClass = 'mauticform-' ~ defaultLabelClass %}
{% set containerClass = containerClass|default(containerType) %}
{% set order = field.order|default(0) %}
{% set validationMessage = '' %}

{% set inputAttributes = htmlAttributesStringToArray(field.inputAttributes|default('')) %}
{% set labelAttributes = htmlAttributesStringToArray(field.labelAttributes|default('')) %}
{% set containerAttributes = htmlAttributesStringToArray(field.containerAttributes|default('')) %}

{% if ignoreName is not defined or (ignoreName is defined and ignoreName is empty) %}
    {% set inputName = 'mauticform[' ~ field.alias ~ ']' %}
    {% if field.properties.multiple is defined %}
        {% set inputName = inputName ~ '[]' %}
    {% endif %}
    {% set inputAttributes = inputAttributes|merge({
        'name': inputName,
    }) %}
{% endif %}

{% if field.type not in ['checkboxgrp', 'radiogrp', 'textarea'] %}
    {% set inputAttributes = inputAttributes|merge({
        'value': field.defaultValue|default(''),
    }) %}
{% endif %}

{% if ignoreId is not defined or (ignoreId is defined and ignoreId is empty) %}
    {% set inputAttributes = inputAttributes|merge({
        'id': 'mauticform_input' ~ formName ~ '_' ~ field.alias,
    }) %}
    {% set labelAttributes = labelAttributes|merge({
        'id': 'mauticform_label' ~ formName ~ '_' ~ field.alias,
        'for': 'mauticform_input' ~ formName ~ '_' ~ field.alias,
    }) %}
{% endif %}

{% if field.properties.placeholder is defined and field.properties.placeholder is not empty %}
    {% set inputAttributes = inputAttributes|merge({
        'placeholder': field.properties.placeholder,
    }) %}
{% endif %}

{# Label and input #}
{% if inForm is defined and (true == inForm or inForm is not empty) %}
    {% if field.type in ['button', 'pagebreak'] %}
        {% set defaultInputFormClass = defaultInputFormClass ~ ' btn btn-ghost' %}
    {% endif %}

    {% set labelAttributes = labelAttributes|merge({
        'class': labelAttributes.class|default([])|merge([defaultLabelClass]),
    }) %}
    {% set inputAttributes = inputAttributes|merge({
        'disabled': 'disabled',
        'class': inputAttributes.class|default([])|merge([defaultInputClass, defaultInputFormClass]),
    }) %}
{% else %}
    {% set labelAttributes = labelAttributes|merge({
        'class': labelAttributes.class|default([])|merge([defaultLabelClass]),
    }) %}
    {% set inputAttributes = inputAttributes|merge({
        'class': inputAttributes.class|default([])|merge([defaultInputClass]),
    }) %}
{% endif %}

{# Container #}
{% set containerAttributes = containerAttributes|merge({
    'id': 'mauticform' ~ formName|default('') ~ '_' ~ id,
    'class': containerAttributes.class|default([])|merge([
        'mauticform-row',
        'mauticform-' ~ containerClass,
        'mauticform-field-' ~ order,
    ]),
}) %}
{% if field.parent and fields[field.parent] is defined %}
    {% set values = field.conditions.values|join('|') %}

    {% if field.conditions.any is not empty and 'notIn' != field.conditions.expr %}
        {% set values = '*' %}
    {% endif %}

    {% set containerAttributes = containerAttributes|merge({
        'data-mautic-form-show-on': fields[field.parent].alias ~ ':' ~ values,
        'data-mautic-form-expr': field.conditions.expr,
        'class': containerAttributes.class|merge([
            'mauticform-field-hidden',
        ]),
    }) %}
{% endif %}

{# Field is required #}
{% if field.isRequired is defined and field.isRequired %}
    {% set required = true %}
    {% set validationMessage = field.validationMessage %}
    {% if validationMessage is empty %}
        {% set validationMessage = 'mautic.form.field.generic.required'|trans([], 'validators') %}
    {% endif %}
    {% set containerAttributes = containerAttributes|merge({
        'class': containerAttributes.class|default([])|merge([
            'mauticform-required',
        ]),
        'data-validate': field.alias,
        'data-validation-type': field.type,
    }) %}
    {% if field.properties.multiple is defined and field.properties.multiple is not empty %}
        {% set containerAttributes = containerAttributes|merge({
            'data-validate-multiple': 'true',
        }) %}
    {% endif %}
{% elseif required is defined and true == required %}
    {# Forced to be required #}
    {% set containerAttributes = containerAttributes|merge({
        'class': containerAttributes.class|default([])|merge([
            'mauticform-required',
        ]),
    }) %}
{% endif %}
{# end: field_helper #}

{% set formName = formName|replace({'_': ''})|default('mauticform') %}

{% block turnstile %}
    {% set siteKey = field.customParameters.site_key|default(null) %}
    {% set explicitConsent = field.properties.explicitConsent|default(false) %}

    {# Unique per-field instance #}
    {% set mmcSuffix = (formName ~ '_' ~ field.alias ~ '_' ~ id)|replace({' ': '', '-': '_'}) %}
    {% set widgetId = 'cf_turnstile_' ~ mmcSuffix %}

    {% if field.showLabel %}
        <label {% for attrName, attrValue in labelAttributes %}{{ attrName }}="{% if attrValue is iterable %}{{ attrValue|join(' ') }}{% else %}{{ attrValue }}{% endif %}"{% endfor %}>
            {{ field.label }}
        </label>
    {% endif %}

    {% if inForm is defined and (true == inForm or inForm is not empty) %}
        <div style="padding: 10px; background: #f5f5f5; border: 1px dashed #ccc; text-align: center;">
            Cloudflare Turnstile Widget ({% if explicitConsent %}explicit{% else %}implicit{% endif %} consent mode)
        </div>
    {% else %}
        {# One tiny global helper. Keep it SMALL to avoid Mautic generate.js escaping issues. #}
        <script type="text/javascript">
        (function(){
            if(window.__mmcTs){return;}
            window.__mmcTs={
                apiLoading:false,
                ensureApi:function(cb){
                    if(window.turnstile){cb&&cb();return;}
                    if(this.apiLoading){
                        var i=0,t=setInterval(function(){
                            i++; if(window.turnstile){clearInterval(t); cb&&cb();}
                            if(i>50){clearInterval(t);}
                        },100);
                        return;
                    }
                    this.apiLoading=true;
                    if(!document.querySelector('script[data-mmc-turnstile-api="1"]')){
                        var s=document.createElement('script');
                        s.src='https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';
                        s.async=true; s.defer=true;
                        s.setAttribute('data-mmc-turnstile-api','1');
                        s.onload=function(){cb&&cb();};
                        document.head.appendChild(s);
                    } else {
                        var j=0,t2=setInterval(function(){
                            j++; if(window.turnstile){clearInterval(t2); cb&&cb();}
                            if(j>50){clearInterval(t2);}
                        },100);
                    }
                },
                render:function(el){
                    if(!window.turnstile || !el || el.dataset.rendered==="1"){return;}
                    el.dataset.rendered="1";
                    window.turnstile.render(el,{
                        sitekey: el.dataset.sitekey,
                        size: el.dataset.size || "normal",
                        theme: el.dataset.theme || "auto",
                        "response-field-name": el.dataset.responseFieldName || "cf-turnstile-response"
                    });
                }
            };
        })();
        </script>

        {% if explicitConsent %}
            <div data-mmc-turnstile-wrapper="{{ mmcSuffix }}" style="margin-bottom:10px;">
                <div style="display:flex; align-items:flex-start;">
                    <input type="checkbox"
                           class="mmc-turnstile-consent"
                           style="margin-right:1rem; margin-top:3px;"
                           onchange="(function(cb){
                               if(!cb.checked){return;}
                               cb.disabled=true;
                               var wrap=cb.closest('[data-mmc-turnstile-wrapper]');
                               if(!wrap){return;}
                               var el=wrap.querySelector('#{{ widgetId }}');
                               if(!el){return;}
                               window.__mmcTs && window.__mmcTs.ensureApi(function(){ window.__mmcTs.render(el); });
                           })(this);" />
                    <label>
                        {{ field.customParameters.stringBag["accept_cookies"] }}<br />
                        <strong>{{ field.customParameters.stringBag["accept_cookies.notice"] }}:</strong>
                        {{ field.customParameters.stringBag["accept_cookies.notice.value"] }}
                    </label>
                </div>
            </div>
        {% endif %}

        <div {% for attrName, attrValue in containerAttributes %}{{ attrName }}="{% if attrValue is iterable %}{{ attrValue|join(' ') }}{% else %}{{ attrValue }}{% endif %}"{% endfor %}>
            <div style="position: relative; top:25px; padding-bottom:25px">
                <span class="mauticform-errormsg" style="display: none;"></span>
            </div>

            <div
                id="{{ widgetId }}"
                class="mmc-turnstile"
                data-sitekey="{{ siteKey }}"
                data-size="{{ field.properties.size }}"
                data-theme="{{ field.properties.theme }}"
                data-response-field-name="cf-turnstile-response"
                style="display:block;"
            ></div>
        </div>

        {# Implicit consent: render immediately for this widget #}
        {% if not explicitConsent %}
            <script type="text/javascript">
            (function(){
                var el=document.getElementById('{{ widgetId }}');
                if(!el || !window.__mmcTs){return;}
                window.__mmcTs.ensureApi(function(){ window.__mmcTs.render(el); });
            })();
            </script>
        {% endif %}
    {% endif %}
{% endblock %}
